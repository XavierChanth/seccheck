#!/bin/bash
#
FULL_PATH_TO_SCRIPT="$(realpath "$0")"
SCRIPT_DIRECTORY="$(dirname "$FULL_PATH_TO_SCRIPT")"
echo $SCRIPT_DIRECTORY
# URL of gChat webhook
# See https://developers.google.com/chat/how-tos/webhooks for more details
URL="INSERT gChat webhook URL"
# leave this many files in the logs directory
# Allows us to investigate and not max out the files
LEAVE="24"
# Get list of ports to test then test them..
PID=$$
DIR="/tmp/seccheck"
mkdir -p $DIR
LOG="$DIR/seccheck.${PID}.log"
for a in `docker service ls |grep secondary:prod |sed 's/.*\*://'|sed 's/->.*$//'`
do
$SCRIPT_DIRECTORY/checksecondary.expect $a >> $LOG
done
RESULTS="`wc -l $LOG |cut -d' ' -f1`"
if (( RESULTS > 0 ))
then
# Send results to gChat
curl --location --request POST ${URL} --header 'Content-Type: application/json' --data-raw "{\"text\": \"${RESULTS} Problematic Secondaries\"}"
fi
#
# Do some tidying up of logs files
COUNT=$(ls -1 $DIR | wc -l)
LEFT=$((COUNT - LEAVE))
[[ $LEFT < 0 ]] && LEFT=0
ls -td $DIR/* |tail -$LEFT|xargs -0 rm -f